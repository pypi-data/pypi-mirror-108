"use strict";
/* Copyright: Ankitects Pty Ltd and contributors
 * License: GNU AGPL, version 3 or later; http://www.gnu.org/licenses/agpl.html */
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var ankiPlatform = "desktop";
var typeans;
var _updatingQueue = Promise.resolve();
var onUpdateHook;
var onShownHook;
function _runHook(arr) {
    const promises = [];
    for (let i = 0; i < arr.length; i++) {
        promises.push(arr[i]());
    }
    return Promise.all(promises);
}
function _queueAction(action) {
    _updatingQueue = _updatingQueue.then(action);
}
function setInnerHTML(element, html) {
    for (const oldVideo of element.getElementsByTagName("video")) {
        oldVideo.pause();
        while (oldVideo.firstChild) {
            oldVideo.removeChild(oldVideo.firstChild);
        }
        oldVideo.load();
    }
    element.innerHTML = html;
    for (const oldScript of element.getElementsByTagName("script")) {
        const newScript = document.createElement("script");
        for (const attribute of oldScript.attributes) {
            newScript.setAttribute(attribute.name, attribute.value);
        }
        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
        oldScript.parentNode.replaceChild(newScript, oldScript);
    }
}
function _updateQA(html, _unusused, onupdate, onshown) {
    return __awaiter(this, void 0, void 0, function* () {
        onUpdateHook = [onupdate];
        onShownHook = [onshown];
        const qa = document.getElementById("qa");
        const renderError = (kind) => (error) => {
            const errorMessage = String(error).substring(0, 2000);
            const errorStack = String(error.stack).substring(0, 2000);
            qa.innerHTML =
                `Invalid ${kind} on card: ${errorMessage}\n${errorStack}`.replace(/\n/g, "<br>");
        };
        // hide current card
        qa.style.opacity = "0";
        // update card
        try {
            setInnerHTML(qa, html);
        }
        catch (error) {
            renderError("HTML")(error);
        }
        yield _runHook(onUpdateHook);
        // wait for mathjax to ready
        yield MathJax.startup.promise
            .then(() => {
            // clear MathJax buffers from previous typesets
            MathJax.typesetClear();
            return MathJax.typesetPromise([qa]);
        })
            .catch(renderError("MathJax"));
        // defer display for up to 100ms to allow images to load
        yield Promise.race([allImagesLoaded(), new Promise((r) => setTimeout(r, 100))]);
        // and reveal card when processing is done
        qa.style.opacity = "1";
        yield _runHook(onShownHook);
    });
}
function _showQuestion(q, bodyclass) {
    _queueAction(() => _updateQA(q, null, function () {
        // return to top of window
        window.scrollTo(0, 0);
        document.body.className = bodyclass;
    }, function () {
        // focus typing area if visible
        typeans = document.getElementById("typeans");
        if (typeans) {
            typeans.focus();
        }
    }));
}
function _showAnswer(a, bodyclass) {
    _queueAction(() => _updateQA(a, null, function () {
        if (bodyclass) {
            //  when previewing
            document.body.className = bodyclass;
        }
        // avoid scrolling to the answer until images load, even if it
        // takes more than 100ms
        allImagesLoaded().then(scrollToAnswer);
    }, function () { }));
}
const _flagColours = {
    1: "#e25252",
    2: "#ffb347",
    3: "#54c414",
    4: "#578cff",
    5: "#ff82ee",
    6: "#00d1b5",
    7: "#9649dd",
};
function _drawFlag(flag) {
    const elem = document.getElementById("_flag");
    if (flag === 0) {
        elem.setAttribute("hidden", "");
        return;
    }
    elem.removeAttribute("hidden");
    elem.style.color = _flagColours[flag];
}
function _drawMark(mark) {
    const elem = document.getElementById("_mark");
    if (!mark) {
        elem.setAttribute("hidden", "");
    }
    else {
        elem.removeAttribute("hidden");
    }
}
function _typeAnsPress() {
    if (window.event.code === "Enter") {
        pycmd("ans");
    }
}
function _emulateMobile(enabled) {
    const list = document.documentElement.classList;
    if (enabled) {
        list.add("mobile");
    }
    else {
        list.remove("mobile");
    }
}
function allImagesLoaded() {
    return Promise.all(Array.from(document.getElementsByTagName("img")).map(imageLoaded));
}
function imageLoaded(img) {
    return img.complete
        ? Promise.resolve()
        : new Promise((resolve) => {
            img.addEventListener("load", () => resolve());
            img.addEventListener("error", () => resolve());
        });
}
function scrollToAnswer() {
    var _a;
    (_a = document.getElementById("answer")) === null || _a === void 0 ? void 0 : _a.scrollIntoView();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV2aWV3ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9xdC9hcXQvZGF0YS93ZWIvanMvcmV2aWV3ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO2tGQUNrRjs7Ozs7Ozs7OztBQU1sRixJQUFJLFlBQVksR0FBRyxTQUFTLENBQUM7QUFDN0IsSUFBSSxPQUFnQyxDQUFDO0FBQ3JDLElBQUksY0FBYyxHQUFrQixPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7QUFFdEQsSUFBSSxZQUE2QixDQUFDO0FBQ2xDLElBQUksV0FBNEIsQ0FBQztBQUVqQyxTQUFTLFFBQVEsQ0FBQyxHQUFvQjtJQUNsQyxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7SUFFcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDakMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzNCO0lBRUQsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2pDLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxNQUFnQjtJQUNsQyxjQUFjLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsT0FBZ0IsRUFBRSxJQUFZO0lBQ2hELEtBQUssTUFBTSxRQUFRLElBQUksT0FBTyxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzFELFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVqQixPQUFPLFFBQVEsQ0FBQyxVQUFVLEVBQUU7WUFDeEIsUUFBUSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDN0M7UUFFRCxRQUFRLENBQUMsSUFBSSxFQUFF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LFFBQVE7UUFDZixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtRQUNuQixDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUNwQixHQUFHLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7WUFDOUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0FBQ2IsQ0FBQztBQUVELFNBQVMsY0FBYzs7SUFDbkIsTUFBQSxRQUFRLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQywwQ0FBRSxjQUFjLEVBQUUsQ0FBQztBQUN4RCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogQ29weXJpZ2h0OiBBbmtpdGVjdHMgUHR5IEx0ZCBhbmQgY29udHJpYnV0b3JzXG4gKiBMaWNlbnNlOiBHTlUgQUdQTCwgdmVyc2lvbiAzIG9yIGxhdGVyOyBodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvYWdwbC5odG1sICovXG5cbmRlY2xhcmUgdmFyIE1hdGhKYXg6IGFueTtcblxudHlwZSBDYWxsYmFjayA9ICgpID0+IHZvaWQgfCBQcm9taXNlPHZvaWQ+O1xuXG52YXIgYW5raVBsYXRmb3JtID0gXCJkZXNrdG9wXCI7XG52YXIgdHlwZWFuczogSFRNTEVsZW1lbnQgfCB1bmRlZmluZWQ7XG52YXIgX3VwZGF0aW5nUXVldWU6IFByb21pc2U8dm9pZD4gPSBQcm9taXNlLnJlc29sdmUoKTtcblxudmFyIG9uVXBkYXRlSG9vazogQXJyYXk8Q2FsbGJhY2s+O1xudmFyIG9uU2hvd25Ib29rOiBBcnJheTxDYWxsYmFjaz47XG5cbmZ1bmN0aW9uIF9ydW5Ib29rKGFycjogQXJyYXk8Q2FsbGJhY2s+KTogUHJvbWlzZTx2b2lkW10+IHtcbiAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcHJvbWlzZXMucHVzaChhcnJbaV0oKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbn1cblxuZnVuY3Rpb24gX3F1ZXVlQWN0aW9uKGFjdGlvbjogQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBfdXBkYXRpbmdRdWV1ZSA9IF91cGRhdGluZ1F1ZXVlLnRoZW4oYWN0aW9uKTtcbn1cblxuZnVuY3Rpb24gc2V0SW5uZXJIVE1MKGVsZW1lbnQ6IEVsZW1lbnQsIGh0bWw6IHN0cmluZyk6IHZvaWQge1xuICAgIGZvciAoY29uc3Qgb2xkVmlkZW8gb2YgZWxlbWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcInZpZGVvXCIpKSB7XG4gICAgICAgIG9sZFZpZGVvLnBhdXNlKCk7XG5cbiAgICAgICAgd2hpbGUgKG9sZFZpZGVvLmZpcnN0Q2hpbGQpIHtcbiAgICAgICAgICAgIG9sZFZpZGVvLnJlbW92ZUNoaWxkKG9sZFZpZGVvLmZpcnN0Q2hpbGQpO1xuICAgICAgICB9XG5cbiAgICAgICAgb2xkVmlkZW8ubG9hZCgpO1xuICAgIH1cblxuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbDtcblxuICAgIGZvciAoY29uc3Qgb2xkU2NyaXB0IG9mIGVsZW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJzY3JpcHRcIikpIHtcbiAgICAgICAgY29uc3QgbmV3U2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNjcmlwdFwiKTtcblxuICAgICAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZSBvZiBvbGRTY3JpcHQuYXR0cmlidXRlcykge1xuICAgICAgICAgICAgbmV3U2NyaXB0LnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUubmFtZSwgYXR0cmlidXRlLnZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG5ld1NjcmlwdC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShvbGRTY3JpcHQuaW5uZXJIVE1MKSk7XG4gICAgICAgIG9sZFNjcmlwdC5wYXJlbnROb2RlLnJlcGxhY2VDaGlsZChuZXdTY3JpcHQsIG9sZFNjcmlwdCk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBfdXBkYXRlUUEoXG4gICAgaHRtbDogc3RyaW5nLFxuICAgIF91bnVzdXNlZDogdW5rbm93bixcbiAgICBvbnVwZGF0ZTogQ2FsbGJhY2ssXG4gICAgb25zaG93bjogQ2FsbGJhY2tcbik6IFByb21pc2U8dm9pZD4ge1xuICAgIG9uVXBkYXRlSG9vayA9IFtvbnVwZGF0ZV07XG4gICAgb25TaG93bkhvb2sgPSBbb25zaG93bl07XG5cbiAgICBjb25zdCBxYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicWFcIikhO1xuICAgIGNvbnN0IHJlbmRlckVycm9yID1cbiAgICAgICAgKGtpbmQ6IHN0cmluZykgPT5cbiAgICAgICAgKGVycm9yOiBFcnJvcik6IHZvaWQgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gU3RyaW5nKGVycm9yKS5zdWJzdHJpbmcoMCwgMjAwMCk7XG4gICAgICAgICAgICBjb25zdCBlcnJvclN0YWNrID0gU3RyaW5nKGVycm9yLnN0YWNrKS5zdWJzdHJpbmcoMCwgMjAwMCk7XG4gICAgICAgICAgICBxYS5pbm5lckhUTUwgPVxuICAgICAgICAgICAgICAgIGBJbnZhbGlkICR7a2luZH0gb24gY2FyZDogJHtlcnJvck1lc3NhZ2V9XFxuJHtlcnJvclN0YWNrfWAucmVwbGFjZShcbiAgICAgICAgICAgICAgICAgICAgL1xcbi9nLFxuICAgICAgICAgICAgICAgICAgICBcIjxicj5cIlxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgIH07XG5cbiAgICAvLyBoaWRlIGN1cnJlbnQgY2FyZFxuICAgIHFhLnN0eWxlLm9wYWNpdHkgPSBcIjBcIjtcblxuICAgIC8vIHVwZGF0ZSBjYXJkXG4gICAgdHJ5IHtcbiAgICAgICAgc2V0SW5uZXJIVE1MKHFhLCBodG1sKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZW5kZXJFcnJvcihcIkhUTUxcIikoZXJyb3IpO1xuICAgIH1cblxuICAgIGF3YWl0IF9ydW5Ib29rKG9uVXBkYXRlSG9vayk7XG5cbiAgICAvLyB3YWl0IGZvciBtYXRoamF4IHRvIHJlYWR5XG4gICAgYXdhaXQgTWF0aEpheC5zdGFydHVwLnByb21pc2VcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gY2xlYXIgTWF0aEpheCBidWZmZXJzIGZyb20gcHJldmlvdXMgdHlwZXNldHNcbiAgICAgICAgICAgIE1hdGhKYXgudHlwZXNldENsZWFyKCk7XG5cbiAgICAgICAgICAgIHJldHVybiBNYXRoSmF4LnR5cGVzZXRQcm9taXNlKFtxYV0pO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2gocmVuZGVyRXJyb3IoXCJNYXRoSmF4XCIpKTtcblxuICAgIC8vIGRlZmVyIGRpc3BsYXkgZm9yIHVwIHRvIDEwMG1zIHRvIGFsbG93IGltYWdlcyB0byBsb2FkXG4gICAgYXdhaXQgUHJvbWlzZS5yYWNlKFthbGxJbWFnZXNMb2FkZWQoKSwgbmV3IFByb21pc2UoKHIpID0+IHNldFRpbWVvdXQociwgMTAwKSldKTtcblxuICAgIC8vIGFuZCByZXZlYWwgY2FyZCB3aGVuIHByb2Nlc3NpbmcgaXMgZG9uZVxuICAgIHFhLnN0eWxlLm9wYWNpdHkgPSBcIjFcIjtcbiAgICBhd2FpdCBfcnVuSG9vayhvblNob3duSG9vayk7XG59XG5cbmZ1bmN0aW9uIF9zaG93UXVlc3Rpb24ocTogc3RyaW5nLCBib2R5Y2xhc3M6IHN0cmluZyk6IHZvaWQge1xuICAgIF9xdWV1ZUFjdGlvbigoKSA9PlxuICAgICAgICBfdXBkYXRlUUEoXG4gICAgICAgICAgICBxLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyByZXR1cm4gdG8gdG9wIG9mIHdpbmRvd1xuICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTtcblxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuY2xhc3NOYW1lID0gYm9keWNsYXNzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBmb2N1cyB0eXBpbmcgYXJlYSBpZiB2aXNpYmxlXG4gICAgICAgICAgICAgICAgdHlwZWFucyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidHlwZWFuc1wiKTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZWFucykge1xuICAgICAgICAgICAgICAgICAgICB0eXBlYW5zLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApXG4gICAgKTtcbn1cblxuZnVuY3Rpb24gX3Nob3dBbnN3ZXIoYTogc3RyaW5nLCBib2R5Y2xhc3M6IHN0cmluZyk6IHZvaWQge1xuICAgIF9xdWV1ZUFjdGlvbigoKSA9PlxuICAgICAgICBfdXBkYXRlUUEoXG4gICAgICAgICAgICBhLFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoYm9keWNsYXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vICB3aGVuIHByZXZpZXdpbmdcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc05hbWUgPSBib2R5Y2xhc3M7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gYXZvaWQgc2Nyb2xsaW5nIHRvIHRoZSBhbnN3ZXIgdW50aWwgaW1hZ2VzIGxvYWQsIGV2ZW4gaWYgaXRcbiAgICAgICAgICAgICAgICAvLyB0YWtlcyBtb3JlIHRoYW4gMTAwbXNcbiAgICAgICAgICAgICAgICBhbGxJbWFnZXNMb2FkZWQoKS50aGVuKHNjcm9sbFRvQW5zd2VyKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmdW5jdGlvbiAoKSB7fVxuICAgICAgICApXG4gICAgKTtcbn1cblxuY29uc3QgX2ZsYWdDb2xvdXJzID0ge1xuICAgIDE6IFwiI2UyNTI1MlwiLFxuICAgIDI6IFwiI2ZmYjM0N1wiLFxuICAgIDM6IFwiIzU0YzQxNFwiLFxuICAgIDQ6IFwiIzU3OGNmZlwiLFxuICAgIDU6IFwiI2ZmODJlZVwiLFxuICAgIDY6IFwiIzAwZDFiNVwiLFxuICAgIDc6IFwiIzk2NDlkZFwiLFxufTtcblxuZnVuY3Rpb24gX2RyYXdGbGFnKGZsYWc6IDAgfCAxIHwgMiB8IDMgfCA0IHwgNSB8IDYgfCA3KTogdm9pZCB7XG4gICAgY29uc3QgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiX2ZsYWdcIik7XG4gICAgaWYgKGZsYWcgPT09IDApIHtcbiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoXCJoaWRkZW5cIiwgXCJcIik7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoXCJoaWRkZW5cIik7XG4gICAgZWxlbS5zdHlsZS5jb2xvciA9IF9mbGFnQ29sb3Vyc1tmbGFnXTtcbn1cblxuZnVuY3Rpb24gX2RyYXdNYXJrKG1hcms6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBlbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJfbWFya1wiKTtcbiAgICBpZiAoIW1hcmspIHtcbiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoXCJoaWRkZW5cIiwgXCJcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoXCJoaWRkZW5cIik7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBfdHlwZUFuc1ByZXNzKCk6IHZvaWQge1xuICAgIGlmICgod2luZG93LmV2ZW50IGFzIEtleWJvYXJkRXZlbnQpLmNvZGUgPT09IFwiRW50ZXJcIikge1xuICAgICAgICBweWNtZChcImFuc1wiKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIF9lbXVsYXRlTW9iaWxlKGVuYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICBjb25zdCBsaXN0ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdDtcbiAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgICBsaXN0LmFkZChcIm1vYmlsZVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBsaXN0LnJlbW92ZShcIm1vYmlsZVwiKTtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGFsbEltYWdlc0xvYWRlZCgpOiBQcm9taXNlPHZvaWRbXT4ge1xuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgICAgQXJyYXkuZnJvbShkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImltZ1wiKSkubWFwKGltYWdlTG9hZGVkKVxuICAgICk7XG59XG5cbmZ1bmN0aW9uIGltYWdlTG9hZGVkKGltZzogSFRNTEltYWdlRWxlbWVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBpbWcuY29tcGxldGVcbiAgICAgICAgPyBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICA6IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICAgIGltZy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLCAoKSA9PiByZXNvbHZlKCkpO1xuICAgICAgICAgICAgICBpbWcuYWRkRXZlbnRMaXN0ZW5lcihcImVycm9yXCIsICgpID0+IHJlc29sdmUoKSk7XG4gICAgICAgICAgfSk7XG59XG5cbmZ1bmN0aW9uIHNjcm9sbFRvQW5zd2VyKCk6IHZvaWQge1xuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiYW5zd2VyXCIpPy5zY3JvbGxJbnRvVmlldygpO1xufVxuIl19